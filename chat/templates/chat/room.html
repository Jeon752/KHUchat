<!DOCTYPE html>
<html>
<head>
    <title>Chat Room</title>
</head>
<body>
    <h1>Welcome to the "{{ room_name }}" chat room!</h1>

    <!-- 비동기식 메시지 창 -->
    <h2>Previous Messages:</h2>
    <div id="chat-history-log"></div>

    <!-- 동기식 메시지 창 -->
    <h2>Real-Time Chat:</h2>
    <div id="chat-log"></div>
    <input id="chat-message-input" type="text" size="100" placeholder="Type your message here...">
    <input id="chat-message-submit" type="button" value="Send">

    <script>
        const roomName = "{{ room_name }}";

        // Load previous messages
        fetch('/chat/load_messages/' + encodeURIComponent(roomName) + '/')
            .then(response => {
                if (!response.ok) {
                    throw new Error("HTTP error " + response.status);
                }
                return response.json();
            })
            .then(data => {
                data.messages.forEach(msg => {
                    document.querySelector('#chat-history-log').innerHTML += 
                        `<div>
                            <a href="/accounts/profile/${msg.username}/">
                                <strong>${msg.username}</strong>
                            </a>: ${msg.content}
                        </div>`;
                });
            })
            .catch(error => console.error('Error fetching messages:', error));

        // WebSocket connection
        const chatSocket = new WebSocket(
            'ws://' + window.location.host + '/ws/chat/' + encodeURIComponent(roomName) + '/'
        );

        // Real-time message handling
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            const chatLog = document.querySelector('#chat-log');
            chatLog.innerHTML += `
                <div>
                    <a href="/accounts/profile/${data.username}/">
                        <strong>${data.username}</strong>
                    </a>: ${data.message}
                </div>`;
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };

        // Send message on button click
        document.querySelector('#chat-message-submit').onclick = function(e) {
            const messageInputDom = document.querySelector('#chat-message-input');
            const message = messageInputDom.value;
            chatSocket.send(JSON.stringify({ 'message': message }));
            messageInputDom.value = '';
        };

        // Send message on Enter key press
        document.querySelector('#chat-message-input').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                document.querySelector('#chat-message-submit').click();
            }
        });
    </script>
</body>
</html>